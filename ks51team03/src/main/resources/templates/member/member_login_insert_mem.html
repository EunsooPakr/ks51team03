<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAL 회원가입 폼</title>
    <link rel="stylesheet" type="text/css" th:href="@{/assets/font/iconic/css/material-design-iconic-font.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/member_custom.css}" >
</head>
<body>
    <div class="member-insert-form-body">
    <!-- <div class="member-insert-form"> -->
    <form class="member-insert-form" id="insertMemberForm" th:action="@{/member/insertMember}" method="post">
       <!-- 로고 -->		
		<a href="/member/member_main" class="logo-single">
			<img th:src="@{/assets/img/pal_logo.png}" alt="IMG-LOGO">
		</a>

        <!-- 1. 아이디 -->
        <div class="login-insert-field-id">
            <b>아이디</b>
            <div>
                <input type="text" id="memberId" placeholder="아이디 입력">
                <input type="button" id="idCheck" value="중복검사">
            </div>
            <a id="idCheckResult" style="display: none;"></a>
        </div>
        
        <!-- 2. 비밀번호 -->
        <div class="login-insert-field">
            <b>비밀번호</b>
            <input class="userpw" type="password" id="memberPw">
        </div>
        <div class="login-insert-field">
            <b>비밀번호 재확인</b>
            <input class="userpw-confirm" type="password">
             <a id="passwordMatchResult" style="display: none;"></a> <!-- 결과를 출력할 <a> 태그 -->
        </div>
        
        <!-- 3. 이름 -->
        <div class="login-insert-field">
            <b>이름</b>
            <input type="text" id="memberName" maxlength="20" oninput="KoreanInput(event)" required>
        </div>

 		<!-- 4. 필드(성별) -->
        <b>성별</b>
        <div class="login-insert-field-button gender">
		    <button class="login-insert-field-button-child gender-btn">남자</button>
		    <button class="login-insert-field-button-child gender-btn">여자</button>
		    <button class="login-insert-field-button-child gender-btn">선택안함</button>
			<input type="text" id="memberGender" style="display: none;" value="">
		</div>

        <!-- 5. 필드(생년월일) -->
        <div class="login-insert-field birth">
            <b>생년월일</b>
            <div>
                <input type="number" placeholder="년(4자)">                
                <select>
                    <option value="">월</option>
                    <option value="">1월</option>
                    <option value="">2월</option>
                    <option value="">3월</option>
                    <option value="">4월</option>
                    <option value="">5월</option>
                    <option value="">6월</option>
                    <option value="">7월</option>
                    <option value="">8월</option>
                    <option value="">9월</option>
                    <option value="">10월</option>
                    <option value="">11월</option>
                    <option value="">12월</option>
                </select>
                <input type="number" placeholder="일">
            </div>
            <input type="text" id="memberBirth" style="display: none;" value="">
        </div>


		<!-- 6. 주소 -->
		<div class="login-insert-field-addr">
            <b>주소</b>
            <div>
                <input type="number" id="postcode" placeholder="우편번호 입력">
                <input type="button" onclick="SearchPostNumberAddr()" value="우편번호 검색">
            </div>
            <input type="text" id="memberAddr" placeholder="주소">
            <input type="text" id="memberAddrDetail" placeholder="상세주소">
        </div>

		
		<!-- 7. 전화번호 -->
        <div class="login-insert-field">
            <b>전화번호</b>
            <input type="tel" id="memberPhone">
        </div>


		<!-- 8. 필드(반려동물 유무) -->
        <b>반려동물 유무</b>
		<div class="login-insert-field-button">
			<button class="login-insert-field-button-child pet-btn">있다</button>
		    <button class="login-insert-field-button-child pet-btn">없다</button>
		    <input type="number" id="memberPet" style="display: none;" value="">
		</div>
        
        <!-- 9. 이메일 인증 -->
        <div class="login-insert-field-tel-number">
        	<br><br>
            <b>이메일 인증</b>
            <form role="form" method="post" th:object="${memberFormDto}">
	            <div class="confirm-group">
	                <input type="email"  id=memberEmail placeholder="이메일 입력" required>
	                <input type="button" id="sendBtn" onclick="sendNumber()" value="인증번호 받기">
	            </div>
	            <div id="confirmEmailNum">
	                <input type="text" id="confirmNum" placeholder="인증번호 입력">
	                <input type="button" id="confirmBtn" onclick="confirmNumber()" value="인증번호 확인">
	            </div>
	            <a id="confirmResult">이메일 인증을 진행해주세요.</a>
	            
	            <input type="text" id="Confirm" name="Confirm" style="display: none" value="">
            
	            <div class="login-insert-field">
			        <!-- 6. 가입하기 버튼 -->
			        <input type="submit" value="가입하기" id="memberInsertBtn">
				</div>
            </form>
        </div>

		
        <!-- 10. 푸터 -->
        <div class="member-insert-form-footer">
            <div>
                <a href="#none">이용약관</a>
                <a href="#none">개인정보처리방침</a>
                <a href="#none">회원정보 고객센터</a>
            </div>
            <span><a href="#none">PALCorp.</a></span>
        </div>
	</form>
   </div>

<script th:src="@{/assets/js/jquery-3.7.1.js}"></script>
<script th:src="@{//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js}"></script>
<script th:src="@{https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js}"></script>
<script th:inline="javascript">

	/* 이메일 인증번호 발송 */
	function sendNumber()
	{
		const confirmResult = $('#confirmResult');
	    /* $("#confirmEmailNum").css("display","block"); */
	    $.ajax({
	        url:"/mail",
	        type:"post",
	        dataType:"json",
	        data:{"mail" : $("#memberEmail").val()},
	        success: function(data){
	        	confirmResult.text('인증번호가 발송되었습니다. 이메일을 확인해주세요.');
	        	confirmResult.show(); 	
	            $("#Confirm").attr("value",data);
	        },
	        error: function(xhr, status, error) {
	        	confirmResult.text('인증번호 발송에 실패하였습니다.');
	        	confirmResult.show(); 	
                console.error(xhr.responseText);
            }
	    });
	}
	
	/* 이메일 인증번호 비교 */
	function confirmNumber(){
	    var number1 = $("#confirmNum").val();
	    var number2 = $("#Confirm").val();
	    const confirmResult = $('#confirmResult');
	    
	    if(number1 == number2&&number1!=null){
	    	confirmResult.text('이메일 인증이 완료되었습니다.');
	    	confirmResult.show(); 	
	    }else{
	    	confirmResult.text('인증번호가 일치하지않습니다.');
	    	confirmResult.show(); 	
	    }
	}


	/*다음 Api로 우편번호 주소 검색*/
	function SearchPostNumberAddr() {
	    new daum.Postcode({
	        oncomplete: function(data) {
	            // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.
	
	            // 각 주소의 노출 규칙에 따라 주소를 조합한다.
	            // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
	            var addr = ''; // 주소 변수
	            var extraAddr = ''; // 참고항목 변수
	
	            //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
	            // 사용자가 도로명 주소를 선택했을 경우
	            if (data.userSelectedType === 'R') 
	            { 
	                addr = data.roadAddress;
	            }
	            else // 사용자가 지번 주소를 선택했을 경우(J)
	            { 
	                addr = data.jibunAddress;
	            }
	
	
	            // 우편번호와 주소 정보를 해당 필드에 넣는다.
	            document.getElementById('postcode').value = data.zonecode;
	            document.getElementById("memberAddr").value = addr;
	            // 커서를 상세주소 필드로 이동한다.
	            document.getElementById("memberAddrDetail").focus();
	        }
	    }).open();
	}


	/* 한글 검사 */
	function KoreanInput(event)
	{
	    var inputValue = event.target.value;			// 입력값
	    var regex = /^[ㄱ-ㅎㅏ-ㅣ가-힣]{0,18}$/; 			// 한글만 입력 받고+최대 20자 제한
	    if (!regex.test(inputValue))
		{
	        alert("한글로만 입력해 주세요 (최대 20자).");
	        event.target.value = ''; 					// 입력 초기화
	    }
	}

    /* Thymeleaf 내부에서 JavaScript 사용 */
    document.addEventListener('DOMContentLoaded', function() {
        var genderButtons = document.querySelectorAll('.gender-btn');
        var petButtons = document.querySelectorAll('.pet-btn');

        /* 성별 버튼 클릭 시 처리 */
        genderButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                // 선택된 버튼에 active 클래스 추가
                genderButtons.forEach(function(btn) {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
            });
        });

        /* 반려동물 유무 버튼 클릭 시 처리 */
        petButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                // 선택된 버튼에 active 클래스 추가
                petButtons.forEach(function(btn) {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
            });
        });
    });
    
    /* 아이디 중복 검사 */
    $('#idCheck').click(function(){
        const memberId = $('#memberId').val();
        if (!memberId) {
            /* alert('회원아이디를 입력해주세요'); */
            $('#memberId').focus();
            return ;
        }
        const request = $.ajax({
            url : '/member/idCheck',
            method : 'POST',
            data : { 'memberId' : memberId },
            dataType : 'json'
        });
        request.done(response => {
            const isMember = response;
            
            $('#addMemberForm input').not('#memberId').prop('disabled', isMember);            
            $('#addMemberForm select').prop('disabled', isMember);            
            $('#addMemberForm button').not('#idCheck').prop('disabled', isMember);
            
            const idCheckResult = $('#idCheckResult');
            if (isMember) {
                idCheckResult.text('회원가입을 할 수 없는 아이디입니다.');
                idCheckResult.show(); 						// 결과 메시지 출력
                $('#memberId').val('');
                $('#memberId').focus();
            } else {
                idCheckResult.text('사용 가능한 아이디입니다.');
                idCheckResult.show(); 						// 결과 메시지 출력
            }
        });
        request.fail((jqXHR, textStatus, error) => {
            console.log(jqXHR, textStatus, error);
        });
    });
    
    /* 비밀번호 재확인 */
     $('.userpw-confirm').keyup(function() {
        var password = $('.userpw').val(); 					// 첫 번째 비밀번호 입력 값
        var confirmPassword = $(this).val(); 				// 비밀번호 재확인 입력 값
        
        var passwordMatchResult = $('#passwordMatchResult');
        
        if (password === confirmPassword) {
            passwordMatchResult.text('비밀번호가 일치합니다.');
            passwordMatchResult.css('color', 'green'); 		// 일치 시 글자색 초록색으로 변경
            passwordMatchResult.show();
        } else {
            passwordMatchResult.text('비밀번호가 일치하지 않습니다.');
            passwordMatchResult.css('color', 'red'); // 불일치 시 글자색 빨간색으로 변경
            passwordMatchResult.show();
        }
    });
    
  	/* 첫 번째 비밀번호 입력 필드의 keyup 이벤트 처리 */
     $('.userpw').keyup(function() {
         // 비밀번호가 변경될 때마다 결과 메시지 숨기기
         $('#passwordMatchResult').hide();
     });
  	
  	/* 회원가입 */
	$('#memberInsertBtn').click(function(){
		let isSubmit = true;
		
		$('#insertMemberForm input, #insertMemberForm select').each( (idx, element) => {
			const id = element.id;
			const value = element.value;
			if(!value){
				alert('필수입력 항목입니다.');
				$(element).focus();
				isSubmit = false;
				return false;
			}
		});
		
		if(isSubmit) $('#insertMemberForm').submit();
	});
</script>
</body>